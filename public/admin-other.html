<!DOCTYPE html>
<html lang="th">
<head>
  <link rel="manifest" href="/manifest-other.json">
  <meta name="theme-color" content="#15563b">

  <meta charset="UTF-8" />
  <title>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á - ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</title>
  <style>
    body { font-family: 'Kanit', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
    h2 { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: center; vertical-align: middle; }
    th { background: #15563b; color: white; }
    img, video { max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    video.rotated-180 { transform: rotate(180deg); }
    .media-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  padding: 10px 0;
}
    a.map-link { color: #2563eb; font-weight: bold; text-decoration: none; }
  </style>
</head>
<body>
  <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á - ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h2>
  <table>
    <thead>
      <tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th><th>‡πÑ‡∏ü‡∏•‡πå</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th></tr>
    </thead>
    <tbody id="data-body"></tbody>
  </table>
  <script>
    async function loadData() {
      const res = await fetch('/data-other-all?_=' + Date.now());
      const data = await res.json();
      const tbody = document.getElementById('data-body');
      tbody.innerHTML = '';
      data.forEach(row => {
        let files = [];
        try { files = row.photo ? JSON.parse(row.photo) : []; } catch (e) { console.error('JSON parse error', e); }
        let fileLinks = "-";
        if (files.length > 0) {
          const first = files[0];
          const firstUrl = typeof first === 'string' ? first : first.url;
          const firstType = first.type || "";

          const firstElement = firstType === 'video'
            ? `<video controls style="width: 150px; height: auto; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
                <source src="${firstUrl}" type="video/mp4">
              </video>`
            : `<img src="${firstUrl}" style="width: 150px; height: auto; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);" />`;

          const buttonHtml = files.length > 1
            ? `<button style="
                  margin-top: 10px;
                  padding: 6px 12px;
                  border: 1px solid #999;
                  border-radius: 6px;
                  background: white;
                  font-weight: bold;
                  cursor: pointer;
              " onclick='showImages(${JSON.stringify(files)})'>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`
            : "";

          fileLinks = `<div class="media-container">${firstElement}${buttonHtml}</div>`;
        }

        const mapLink = row.latitude && row.longitude ? `<a class="map-link" href="https://www.google.com/maps?q=${row.latitude},${row.longitude}" target="_blank">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>` : '-';
        const statusSelect = `
          <select onchange="setStatus(${row.id}, this.value)">
            <option value="" disabled ${(row.status === null || row.status === undefined || row.status === '') ? 'selected' : ''}>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${row.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${row.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ${row.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
          </select>
        `;

        tbody.innerHTML += `
          <tr>
            <td>${row.name || '-'}</td>
            <td>${row.phone || '-'}</td>
            <td>${row.message || '-'}</td>
            <td>${fileLinks || '-'}</td>
            <td>${row.department || '-'}</td>
            <td>${statusSelect}</td>
            <td>${mapLink}</td>
          </tr>
        `;
      });
    }
    loadData();
  // ‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(function () {
        console.log('‚úÖ Service Worker Registered');
      });
    }
  </script>
  <script>
  function showImages(images) {
    const html = images.map(img => {
      const url = typeof img === 'string' ? img : img.url;
      const type = img.type || "";

      if (type === 'video' || url.toLowerCase().match(/\.(mp4|mov|avi)(\?|$)/)) {
            return `
              <video controls style="
                width: auto;
                max-width: 700px;
                max-height: 500px;
                margin-bottom: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.2);
              ">
                <source src="${url}" type="video/mp4">
              </video>`;
          }

          return `
            <img src="${url}" style="
              width: auto;
              max-width: 700px;
              max-height: 500px;
              margin-bottom: 20px;
              border-radius: 8px;
              object-fit: contain;
              box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            " />`;
        }).join('');

        const win = window.open('', '_blank', 'width=800,height=600');
        win.document.write(`
          <body style="font-family:kanit; padding:30px; text-align:center; background:#f9f9f9">
            ${html}
          </body>
        `);
      }
  </script>
  <script>
    function setStatus(id, status) {
      fetch(`/set-status/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status })
      }).then(res => {
        if (res.ok) {
          alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        } else {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
        }
      });
    }
  </script>


</body>
</html>
